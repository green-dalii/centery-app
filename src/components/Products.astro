---
import { Icon } from 'astro-icon/components';
---
<div class="relative">
    <div class="sticky top-14 bg-base-100 z-20 p-4 border-b border-base-200">
        <div class="flex items-center justify-between text-base text-primary font-bold mb-4">
            <div class="flex items-center">
                <Icon name="mdi:store" class="text-xl mr-2" />
                <h2>智慧鑫诚商城</h2>
            </div>
            <button id="refresh-button" class="btn btn-ghost btn-sm p-2" title="刷新商品">
                <Icon name="mdi:refresh" class="text-lg" />
            </button>
        </div>
        <div class="flex">
            <input type="text" id="search-input" class="input input-bordered flex-1 rounded-r-none" placeholder="搜索商品...">
            <button id="search-button" class="btn btn-primary text-nowrap rounded-l-none">搜索</button>
        </div>
    </div>
    <div class="p-4 pt-0">
    <div id="loading-indicator" class="text-center py-10">载入中...</div>
    <div id="products-container" class="hidden">
      <div id="products-list" class="flex flex-col gap-4">
        <!-- Product items will be injected here -->
      </div>
    </div>
    <div id="pagination-container" class="mt-4 flex justify-center items-center space-x-2">
        <!-- Pagination will be loaded here -->
    </div>
    </div>
</div>

<dialog id="add_to_cart_modal" class="modal">
  <div class="modal-box">
    <h3 id="modal-product-name" class="font-bold text-lg mb-4"></h3>
    <div class="grid grid-cols-1 gap-4 text-sm">
      <div class="flex items-center">
        <span class="w-16">单价</span>
        <p id="modal-product-price" class="font-semibold"></p>
      </div>
      <div class="flex items-center">
        <span class="w-16">库存</span>
        <p id="modal-product-stock" class="font-semibold"></p>
      </div>
      <div class="flex items-center">
        <span class="w-16">下单量</span>
        <div class="join">
          <button id="quantity-minus" class="btn join-item">-</button>
          <input id="modal-quantity-input" type="number" value="1" min="1" class="input input-bordered join-item text-center w-20"/>
          <button id="quantity-plus" class="btn join-item">+</button>
        </div>
        <p id="modal-product-unit" class="ml-2"></p>
      </div>
    </div>
    <div class="modal-action mt-6">
      <button id="modal-add-to-cart-btn" class="btn btn-primary">加入购物车</button>
      <form method="dialog">
        <button class="btn">取消</button>
      </form>
    </div>
  </div>
</dialog>

<script>
    let authToken = localStorage.getItem('authToken');
    let currentPageToken = '';
    let hasMore = false;
    let pageTokens: string[] = [];
    let currentPageIndex = 0;
    let initialY = 0;
    let isRefreshing = false;

    async function apiCall(endpoint: string, options: any = {}) {
        const config = {
            headers: {
                'Content-Type': 'application/json',
                ...(authToken && { 'Authorization': `Bearer ${authToken}` })
            },
            ...options
        };

        try {
            const response = await fetch(`/api${endpoint}`, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'API request failed');
            }
            
            return data;
        } catch (error: any) {
            console.error('API Error:', error);
            throw error;
        }
    }

    async function loadProducts(pageToken = '', searchTerm = '', forceRefresh = false) {
        const loadingIndicator = document.getElementById('loading-indicator');
        const productsContainer = document.getElementById('products-container');
        const productsList = document.getElementById('products-list');
        
        if (!isRefreshing) {
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (productsContainer) productsContainer.classList.add('hidden');
        }

        const cacheKey = `products_${searchTerm}_${pageToken}`;
        
        if (!forceRefresh) {
            const cachedData = sessionStorage.getItem(cacheKey);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                renderProducts(data.products);
                hasMore = data.hasMore;
                currentPageToken = data.nextPageToken;
                updatePagination();
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (productsContainer) productsContainer.classList.remove('hidden');
                return;
            }
        }

        try {
            const data = await apiCall(`/products?pageSize=10&pageToken=${pageToken}&q=${encodeURIComponent(searchTerm)}`);
            sessionStorage.setItem(cacheKey, JSON.stringify(data));
            renderProducts(data.products);
            hasMore = data.hasMore;
            currentPageToken = data.nextPageToken;
            updatePagination();
        } catch (error: any) {
            (window as any).showToast('加载商品失败', 'error');
            if (productsList) {
                productsList.innerHTML = '<p class="text-center text-gray-500">加载失败，请稍后重试。</p>';
            }
        } finally {
            if (loadingIndicator) loadingIndicator.classList.add('hidden');
            if (productsContainer) productsContainer.classList.remove('hidden');
        }
    }

    function renderProducts(products: any[]) {
        const productsList = document.getElementById('products-list');
        if (!productsList) return;
        
        if (products.length === 0) {
            productsList.innerHTML = '<p class="text-center text-gray-500">没有找到相关商品。</p>';
            return;
        }

        productsList.innerHTML = products.map((product: any) => {
            const stockValue = product.stock && product.stock.value && product.stock.value.length > 0 ? product.stock.value[0] : 0;
            const isOutOfStock = stockValue <= 0;
            const productForButton = { ...product, stock: stockValue };

            return `
            <div class="bg-base-200 rounded-lg border border-base-300 shadow-sm overflow-hidden flex items-center p-2" data-record-id="${product.id}">
                <div class="w-20 h-20 bg-base-200 rounded-md overflow-hidden flex-shrink-0">
                    ${product.image ? `<img src="${product.image}" alt="${product.name}" class="lazyload w-full h-full object-cover" loading="lazy">` : ''}
                </div>
                <div class="pl-4 flex-1">
                    <h3 class="font-medium text-base-content truncate">${product.name}</h3>
                    <p class="text-xs text-base-content/50">${product.type || '&nbsp;'}</p>
                    <div class="flex items-baseline">
                        <span class="text-lg font-bold text-primary">¥${product.price}</span>
                        <span class="text-xs text-base-content/70 ml-1">/${product.unit}</span>
                    </div>
                </div>
                <button 
                    class="add-to-cart-btn ${isOutOfStock ? 'bg-base-300 cursor-not-allowed text-base-content' : 'bg-primary hover:opacity-90 text-white'} px-3 py-1 rounded-md text-sm ml-4" 
                    data-product='${JSON.stringify(productForButton)}'
                    ${isOutOfStock ? 'disabled' : ''}
                >
                    ${isOutOfStock ? '已售罄' : '加入购物车'}
                </button>
            </div>
        `}).join('');
    }

    function updatePagination() {
        const paginationContainer = document.getElementById('pagination-container');
        if (!paginationContainer) return;

        let prevButtonHTML = `<button id="prev-page" class="btn btn-sm" ${currentPageIndex === 0 ? 'disabled' : ''}>上一页</button>`;
        let nextButtonHTML = `<button id="next-page" class="btn btn-sm" ${!hasMore ? 'disabled' : ''}>下一页</button>`;

        paginationContainer.innerHTML = `${prevButtonHTML} ${nextButtonHTML}`;

        document.getElementById('prev-page')?.addEventListener('click', () => {
            if (currentPageIndex > 0) {
                currentPageIndex--;
                loadProducts(pageTokens[currentPageIndex], (document.getElementById('search-input') as HTMLInputElement).value);
            }
        });

        document.getElementById('next-page')?.addEventListener('click', () => {
            if (hasMore) {
                if (!pageTokens.includes(currentPageToken)) {
                    pageTokens.push(currentPageToken);
                }
                currentPageIndex++;
                loadProducts(currentPageToken, (document.getElementById('search-input') as HTMLInputElement).value);
            }
        });
    }

    interface Product {
        id: string;
        name: string;
        price: number;
        unit: string;
        stock: number;
        quantity?: number;
        selected?: boolean;
    }

    function addToCart(product: Product, quantity: number = 1) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]') as Product[];
        const existingProduct = cart.find(item => item.id === product.id);

        if (existingProduct) {
            existingProduct.quantity = (existingProduct.quantity || 0) + quantity;
        } else {
            cart.push({ ...product, quantity, selected: true });
        }

        localStorage.setItem('cart', JSON.stringify(cart));
        (window as any).showToast('已添加到购物车', 'success');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const quantityInput = document.getElementById('modal-quantity-input') as HTMLInputElement;
        const quantityMinus = document.getElementById('quantity-minus');
        const quantityPlus = document.getElementById('quantity-plus');

        quantityMinus?.addEventListener('click', () => {
            let currentValue = parseInt(quantityInput.value, 10);
            if (currentValue > 1) {
                quantityInput.value = (currentValue - 1).toString();
            }
        });

        quantityPlus?.addEventListener('click', () => {
            const max = parseInt(quantityInput.max, 10);
            let currentValue = parseInt(quantityInput.value, 10);
            if (currentValue < max) {
                quantityInput.value = (currentValue + 1).toString();
            }
        });

        quantityInput?.addEventListener('change', () => {
            const max = parseInt(quantityInput.max, 10);
            if (isNaN(max)) return;
            let currentValue = parseInt(quantityInput.value, 10);
            if (currentValue > max) {
                quantityInput.value = max.toString();
            }
            if (currentValue < 1) {
                quantityInput.value = "1";
            }
        });

        // Add event listener for modal add to cart button
        const modalAddToCartBtn = document.getElementById('modal-add-to-cart-btn');
        if (modalAddToCartBtn) {
            modalAddToCartBtn.addEventListener('click', () => {
                const productData = JSON.parse(modalAddToCartBtn.getAttribute('data-product') || '{}') as Product;
                const quantityInput = document.getElementById('modal-quantity-input') as HTMLInputElement;
                const quantityToAdd = parseInt(quantityInput.value, 10);

                let cart = JSON.parse(localStorage.getItem('cart') || '[]') as Product[];
                const existingProduct = cart.find(item => item.id === productData.id);
                const quantityInCart = existingProduct ? (existingProduct.quantity || 0) : 0;

                if (quantityToAdd + quantityInCart > productData.stock) {
                    (window as any).showToast(`库存不足，您最多还能添加 ${productData.stock - quantityInCart} 件`, 'error');
                    return;
                }

                if (productData.id && quantityToAdd > 0) {
                    addToCart(productData, quantityToAdd);
                    const addToCartModal = document.getElementById('add_to_cart_modal') as HTMLDialogElement;
                    if (addToCartModal) {
                        addToCartModal.close();
                    }
                }
            });
        }
        document.addEventListener('loadproducts', () => {
            if (localStorage.getItem('authToken')) {
                pageTokens = [''];
                currentPageIndex = 0;
                sessionStorage.clear(); // Clear cache on new search
                loadProducts('', '', true);
            }
        });

        document.getElementById('search-button')?.addEventListener('click', () => {
            const searchTerm = (document.getElementById('search-input') as HTMLInputElement).value;
            pageTokens = [''];
            currentPageIndex = 0;
            sessionStorage.clear(); // Clear cache on new search
            loadProducts('', searchTerm, true);
        });

        document.getElementById('products-list')?.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            const button = target.closest('.add-to-cart-btn');
            if (button) {
                const productData = JSON.parse(button.getAttribute('data-product') || '{}');
                
                const addToCartModal = document.getElementById('add_to_cart_modal') as any;
                const modalProductName = document.getElementById('modal-product-name');
                const modalProductPrice = document.getElementById('modal-product-price');
                const modalProductUnit = document.getElementById('modal-product-unit');
                const modalProductStock = document.getElementById('modal-product-stock');
                const modalQuantityInput = document.getElementById('modal-quantity-input') as HTMLInputElement;
                const modalAddToCartBtn = document.getElementById('modal-add-to-cart-btn') as HTMLButtonElement;

                if (modalProductName) modalProductName.textContent = productData.name;
                if (modalProductPrice) modalProductPrice.textContent = `¥${productData.price}`;
                if (modalProductUnit) modalProductUnit.textContent = productData.unit;
                if (modalProductStock) modalProductStock.textContent = productData.stock;
                
                if (modalQuantityInput && modalAddToCartBtn) {
                    let cart = JSON.parse(localStorage.getItem('cart') || '[]') as Product[];
                    const existingProduct = cart.find(item => item.id === productData.id);
                    const quantityInCart = existingProduct ? (existingProduct.quantity || 0) : 0;
                    const maxQuantity = productData.stock - quantityInCart;

                    modalQuantityInput.value = '1';
                    modalQuantityInput.max = maxQuantity.toString();

                    if (maxQuantity <= 0) {
                        modalQuantityInput.value = '0';
                        modalQuantityInput.disabled = true;
                        modalAddToCartBtn.disabled = true;
                    } else {
                        modalQuantityInput.disabled = false;
                        modalAddToCartBtn.disabled = false;
                    }
                }
                
                if (modalAddToCartBtn) {
                    modalAddToCartBtn.setAttribute('data-product', button.getAttribute('data-product') || '{}');
                }

                if (addToCartModal) {
                    addToCartModal.showModal();
                }
            }
        });

        // 添加刷新按钮事件监听器
        document.getElementById('refresh-button')?.addEventListener('click', () => {
            const searchTerm = (document.getElementById('search-input') as HTMLInputElement).value;
            pageTokens = [''];
            currentPageIndex = 0;
            sessionStorage.clear();
            loadProducts('', searchTerm, true);
        });
    });

    document.addEventListener('orderplaced', () => {
        sessionStorage.clear();
        pageTokens = [''];
        currentPageIndex = 0;
        loadProducts('', '', true);
    });

    document.addEventListener('tabswitched', (event: any) => {
        if (event.detail.tab === 'products') {
            const cacheKey = 'products__';
            const cachedData = sessionStorage.getItem(cacheKey);
            if (!cachedData) {
                pageTokens = [''];
                currentPageIndex = 0;
                loadProducts('', '', true);
            } else {
                const data = JSON.parse(cachedData);
                renderProducts(data.products);
                hasMore = data.hasMore;
                currentPageToken = data.nextPageToken;
                updatePagination();
                const loadingIndicator = document.getElementById('loading-indicator');
                const productsContainer = document.getElementById('products-container');
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (productsContainer) productsContainer.classList.remove('hidden');
            }
        }
    });
</script>