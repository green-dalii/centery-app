---
import { Icon } from 'astro-icon/components';
---
<div class="p-4">
    <div class="flex items-center text-base text-primary font-bold mb-4">
        <Icon name="mdi:account" class="text-xl mr-2" />
        <h2>我的</h2>
    </div>
    <div class="mb-6">
        <div class="flex items-center justify-between space-x-4 mb-4">
            <div class="flex items-center space-x-4">
                <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center">
                    <span class="text-primary-content text-xl font-bold" id="user-avatar">U</span>
                </div>
                <div>
                    <h3 class="font-semibold text-base-content" id="user-name">用户名</h3>
                    <p class="text-sm text-base-content/60">欢迎使用智慧鑫诚</p>
                </div>
            </div>
            <button id="logout-btn" class="btn btn-error">退出登录</button>
        </div>
    </div>

    <div class="space-y-4">
        <!-- Orders Section -->
        <div class="bg-base-200 rounded-lg border border-base-300 p-4">
            <h4 class="font-medium text-base-content mb-3">我的订单</h4>
            <div id="order-filters" class="flex space-x-2 mb-4 overflow-x-auto pb-2">
                <button class="btn btn-soft filter-btn" data-status="pending">已下单</button>
                <button class="btn btn-soft filter-btn" data-status="processing">待发货</button>
                <button class="btn btn-soft filter-btn" data-status="shipped">待收货</button>
                <button class="btn btn-soft filter-btn" data-status="received">已签收</button>
                <button class="btn btn-soft filter-btn" data-status="completed">已结算</button>
                <button class="btn btn-soft filter-btn" data-status="cancelled">已取消</button>
                <button class="btn btn-soft filter-btn" data-status="all">全部订单</button>
            </div>
            <div id="orders-list" class="space-y-3">
                <!-- Orders will be loaded here -->
            </div>
        </div>

        <!-- Addresses Section -->
        <div class="bg-base-200 rounded-lg border border-base-300 p-4">
            <h4 class="font-medium text-base-content mb-3">地址管理</h4>
            <div id="addresses-list" class="space-y-3">
                <!-- Addresses will be loaded here -->
            </div>
            <button id="add-address-btn" class="btn btn-outline btn-primary w-full mt-3">+ 添加新地址</button>
        </div>

    </div>
</div>

<!-- Address Modal -->
<dialog id="address-modal" class="modal">
    <div class="modal-box">
        <form method="dialog">
            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 id="modal-title" class="font-bold text-lg mb-4">添加新地址</h3>
        <form id="address-form" class="space-y-4">
            <input type="hidden" id="address-id">
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs text-base-content">收件人</span>
                </label>
                <input type="text" id="recipient-name" name="recipient_name" class="input input-bordered w-full" required>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs text-base-content">联系电话</span>
                </label>
                <input type="tel" id="phone" name="phone" class="input input-bordered w-full" required>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-xs text-base-content">详细地址</span>
                </label>
                <textarea id="address" name="address" rows="3" class="textarea textarea-bordered w-full" required></textarea>
            </div>
            <div class="form-control">
                <label class="label cursor-pointer">
                    <span class="label-text text-xs text-base-content">设为默认地址</span>
                    <input type="checkbox" id="is_default" name="is_default" class="checkbox checkbox-primary" />
                </label>
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-ghost" id="cancel-address-modal-btn">取消</button>
                <button type="submit" class="btn btn-primary" id="save-address-btn">保存</button>
            </div>
        </form>
    </div>
</dialog>

<style>
    .filter-btn {
        font-size: 0.875rem;
        white-space: nowrap;
    }
</style>

<script>
    import { globalApiCall } from '../utils/api.ts';
    
    let currentUser: any = null;
    let allOrders: any[] = [];
    let currentFilter = '';

    // 使用全局API调用函数
    const apiCall = globalApiCall;

    function updateUI() {
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const ordersList = document.getElementById('orders-list');
        const addressesList = document.getElementById('addresses-list');

        if (currentUser) {
            if (userName) userName.textContent = currentUser.username;
            if (userAvatar) userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
        } else {
            if (userName) userName.textContent = '用户名';
            if (userAvatar) userAvatar.textContent = 'U';
            if (ordersList) ordersList.innerHTML = '<div class="text-center text-gray-500 py-8">请先登录</div>';
            if (addressesList) addressesList.innerHTML = '<div class="text-center text-gray-500 py-4">请先登录</div>';
        }
    }

    async function loadProfile(forceRefresh = false) {
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
            currentUser = null;
            updateUI();
            return;
        }
        try {
            const data = await apiCall('/user/profile');
            currentUser = data.user;
            updateUI();
            loadOrders(forceRefresh);
            loadAddresses();
            
            // Initialize button states
            initializeFilterButtons();
        } catch (error) {
            console.error("Failed to load profile", error);
            currentUser = null;
            updateUI();
        }
    }
    
    function initializeFilterButtons() {
        const filterContainer = document.getElementById('order-filters');
        if (!filterContainer) return;
        
        const allButtons = filterContainer.querySelectorAll('.filter-btn');
        allButtons.forEach((btn, index) => {
            btn.className = 'filter-btn btn btn-soft';
        });
    }

    // --- Order Logic ---
    const orderStatusMap: { [key: string]: string } = {
        pending: '已下单',
        processing: '待发货',
        shipped: '待收货',
        received: '已签收',
        completed: '已结算',
        cancelled: '已取消'
    };

    function renderOrders(isLoading = false) {
        const ordersList = document.getElementById('orders-list');
        if (!ordersList) return;

        if (isLoading) {
            ordersList.innerHTML = '<div class="text-center text-gray-500 py-8"><span class="loading loading-spinner loading-md"></span> 载入中...</div>';
            return;
        }

        if (!currentFilter) {
            ordersList.innerHTML = '<div class="text-center text-gray-500 py-8">请选择一个分类以查看订单</div>';
            return;
        }

        const filteredOrders = currentFilter === 'all' 
            ? allOrders 
            : allOrders.filter(order => order.status === currentFilter);

        if (filteredOrders.length === 0) {
            ordersList.innerHTML = '<div class="text-center text-gray-500 py-8">该分类下暂无订单</div>';
            return;
        }

        ordersList.innerHTML = filteredOrders.map((order: any) => {
            // 获取商品信息
            const itemsHtml = order.items ? order.items.map((item: any) => {
                // 从sessionStorage获取商品信息
                let productName = `商品ID: ${item.productId}`;
                
                try {
                    // 尝试从所有可能的缓存键获取商品数据
                    let foundProduct = null;
                    
                    // 遍历所有sessionStorage键，查找商品缓存
                    for (let i = 0; i < sessionStorage.length; i++) {
                        const key = sessionStorage.key(i);
                        if (key && key.startsWith('products_')) {
                            const cachedData = sessionStorage.getItem(key);
                            if (cachedData) {
                                const data = JSON.parse(cachedData);
                                const product = data.products?.find((p: any) => p.id === item.productId);
                                if (product && product.name) {
                                    foundProduct = product;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (foundProduct) {
                        productName = foundProduct.name;
                    }
                } catch (e) {
                    console.warn('获取商品信息失败:', e);
                }
                
                return `
                    <div class="flex justify-between items-center text-xs">
                        <span>${productName} × ${item.quantity}</span>
                        <span class="font-medium">¥${(typeof item.amount === 'number' ? item.amount : parseFloat(item.amount) || 0).toFixed(2)}</span>
                    </div>
                `;
            }).join('') : '';
            
            return `
                <div class="bg-base-300 rounded-lg p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-gray-600">订单号: ${order.id}</span>
                        <span class="text-xs text-nowrap font-medium px-2 py-1 rounded-full ${
                            order.status === 'pending' ? 'bg-red-100 text-red-800' :
                            order.status === 'processing' ? 'bg-orange-100 text-orange-800' :
                            order.status === 'shipped' ? 'bg-yellow-100 text-yellow-800' :
                            order.status === 'received' ? 'bg-green-100 text-green-800' :
                            order.status === 'completed' ? 'bg-sky-100 text-sky-800' :
                            order.status === 'cancelled' ? 'bg-neutral-100 text-neutral-800' :
                            'bg-primary text-primary-content'
                        }">${orderStatusMap[order.status] || order.status}</span>
                    </div>
                    ${itemsHtml ? `<div class="mb-2 space-y-1">${itemsHtml}</div>` : ''}
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-primary">总计: ¥${order.total.toFixed(2)}</span>
                        <span class="text-xs text-gray-500">${new Date(order.created_at).toLocaleString()}</span>
                    </div>
                    ${order.address ? `
                        <div class="text-xs text-gray-600 border-t pt-2">
                            <div>收货人: ${order.address.recipient_name} ${order.address.phone}</div>
                            <div>地址: ${order.address.address}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    async function loadOrders(forceRefresh = false) {
        const cacheKey = 'user_orders';
        
        // 如果不强制刷新，先尝试从缓存读取
        if (!forceRefresh) {
            const cachedData = sessionStorage.getItem(cacheKey);
            if (cachedData) {
                try {
                    allOrders = JSON.parse(cachedData);
                    renderOrders();
                    return;
                } catch (e) {
                    console.warn('解析缓存订单数据失败:', e);
                }
            }
        }
        
        try {
            const data = await apiCall('/orders');
            allOrders = data.orders || [];
            // 将订单数据存储到SessionStorage
            sessionStorage.setItem(cacheKey, JSON.stringify(allOrders));
            renderOrders(); // Initial render will now show the placeholder
        } catch (error: any) {
            // globalApiCall已经处理了401错误和Toast显示
            if (!error.message.includes('未授权')) {
                (window as any).showToast('加载订单失败', 'error');
            }
        }
    }

    // --- Address Logic ---
    function renderAddresses(addresses: any[]) {
        const addressesList = document.getElementById('addresses-list');
        if (!addressesList) return;

        if (addresses.length === 0) {
            addressesList.innerHTML = '<div class="text-center text-gray-500 py-4">暂无收货地址</div>';
            return;
        }

        addressesList.innerHTML = addresses.map(addr => `
            <div class="border-t pt-3">
                <div class="flex justify-between items-start">
                    <div>
                        <div class="flex items-center">
                            <p class="font-semibold">${addr.recipient_name} <span class="font-normal text-gray-600 ml-2">${addr.phone}</span></p>
                            ${addr.is_default ? '<span class="ml-2 px-2 py-0.5 text-xs bg-primary-100 text-primary-700 rounded-full">默认</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${addr.address}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="edit-address-btn text-sm text-blue-600 hover:underline" data-id="${addr.id}">编辑</button>
                        <button class="delete-address-btn text-sm text-red-600 hover:underline" data-id="${addr.id}">删除</button>
                    </div>
                </div>
            </div>
        `).join('');

        document.querySelectorAll('.edit-address-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = (e.target as HTMLElement).dataset.id;
                const addressToEdit = addresses.find(a => a.id == id);
                if (addressToEdit) {
                    openAddressModal(addressToEdit);
                }
            });
        });

        document.querySelectorAll('.delete-address-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const id = (e.target as HTMLElement).dataset.id;
                if (confirm('确定要删除这个地址吗？')) {
                    try {
                        await apiCall(`/user/addresses/${id}`, { method: 'DELETE' });
                        (window as any).showToast('地址删除成功', 'success');
                        loadAddresses();
                    } catch (error) {
                        // API call already shows toast
                    }
                }
            });
        });
    }

    async function loadAddresses() {
        try {
            const data = await apiCall('/user/addresses');
            renderAddresses(data.addresses || []);
        } catch (error) {
            // globalApiCall已经处理了401错误和Toast显示
        }
    }

    function openAddressModal(address: any = null) {
        const modal = document.getElementById('address-modal') as HTMLDialogElement;
        const form = document.getElementById('address-form') as HTMLFormElement;
        const modalTitle = document.getElementById('modal-title');
        
        if (!modal || !form || !modalTitle) return;

        form.reset();
        (document.getElementById('address-id') as HTMLInputElement).value = address ? address.id : '';
        (document.getElementById('recipient-name') as HTMLInputElement).value = address ? address.recipient_name : '';
        (document.getElementById('phone') as HTMLInputElement).value = address ? address.phone : '';
        (document.getElementById('address') as HTMLTextAreaElement).value = address ? address.address : '';
        (document.getElementById('is_default') as HTMLInputElement).checked = address ? address.is_default : false;
        modalTitle.textContent = address ? '编辑地址' : '添加新地址';

        modal.showModal();
    }

    function closeAddressModal() {
        const modal = document.getElementById('address-modal') as HTMLDialogElement;
        if (!modal) return;
        modal.close();
    }

    async function handleAddressFormSubmit(e: Event) {
        e.preventDefault();
        const form = e.target as HTMLFormElement;
        const id = (form.querySelector('#address-id') as HTMLInputElement).value;
        const saveBtn = document.getElementById('save-address-btn') as HTMLButtonElement;
        
        // 保存原始按钮内容并设置loading状态
        const originalButtonContent = saveBtn?.innerHTML;
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = `<span class="loading loading-spinner loading-sm"></span> 保存中...`;
        }

        const data = {
            recipient_name: (form.querySelector('#recipient-name') as HTMLInputElement).value,
            phone: (form.querySelector('#phone') as HTMLInputElement).value,
            address: (form.querySelector('#address') as HTMLTextAreaElement).value,
            is_default: (form.querySelector('#is_default') as HTMLInputElement).checked
        };

        const method = id ? 'PUT' : 'POST';
        const endpoint = id ? `/user/addresses/${id}` : '/user/addresses';

        try {
            await apiCall(endpoint, { method, body: JSON.stringify(data) });
            (window as any).showToast(`地址${id ? '更新' : '添加'}成功`, 'success');
            closeAddressModal();
            loadAddresses();
        } catch (error) {
            // API call already shows toast
        } finally {
            // 恢复按钮状态
            if (saveBtn && originalButtonContent) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalButtonContent;
            }
        }
    }

    // --- General & Event Listeners ---
    function logout() {
        localStorage.removeItem('authToken');
        currentUser = null;
        allOrders = [];
        updateUI();
        renderOrders();
        renderAddresses([]);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                localStorage.removeItem('authToken');
                currentUser = null;
                updateUI();
                window.location.href = '/'; 
                document.dispatchEvent(new CustomEvent('logoutsuccess'));
            });
        }

        // Order filter listeners
        const filterContainer = document.getElementById('order-filters');
        filterContainer?.addEventListener('click', async (e) => {
            const target = e.target as HTMLElement;
            if (target.classList.contains('filter-btn')) {
                // Remove active state from all buttons
                const allButtons = filterContainer.querySelectorAll('.filter-btn');
                allButtons.forEach(btn => {
                    btn.classList.remove('active', 'btn-primary');
                    btn.className = 'filter-btn btn btn-soft';
                });
                
                // Add active state to clicked button
                target.classList.add('active');
                target.className = 'filter-btn btn btn-soft btn-primary active';
                
                currentFilter = target.dataset.status || 'all';
                
                // 显示loading状态
                renderOrders(true);
                
                // 模拟数据加载延迟，然后显示实际数据
                setTimeout(() => {
                    renderOrders();
                }, 100);
            }
        });

        // Address modal listeners
        document.getElementById('add-address-btn')?.addEventListener('click', () => openAddressModal());
        document.getElementById('address-form')?.addEventListener('submit', handleAddressFormSubmit);
        document.getElementById('cancel-address-modal-btn')?.addEventListener('click', closeAddressModal);

        loadProfile();
    });

    document.addEventListener('tabswitched', (event: any) => {
        if (event.detail.tab === 'profile') {
            loadProfile(true);
        }
    });

    document.addEventListener('loginsuccess', () => {
        loadProfile();
    });
</script>