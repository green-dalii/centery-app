---
import { Icon } from 'astro-icon/components';
---

<div class="p-6">
    <!-- LOGO Hero -->
    <div class="flex justify-center my-14">
        <Icon name="centery-logo" class="text-7xl" />
    </div>
    <div class="mb-6">
        <div class="flex bg-base-200 rounded-lg p-1 mb-6">
            <button id="login-btn" class="flex-1 py-2 px-4 rounded-md bg-base-100 shadow-sm font-medium text-primary">登录</button>
            <button id="register-btn" class="flex-1 py-2 px-4 rounded-md font-medium text-base-content/60">注册</button>
        </div>
    </div>

    <!-- Login Form -->
    <div id="login-form" class="space-y-4">
        <div>
            <label class="block text-xs font-medium text-base-content mb-2">用户名</label>
            <input type="text" id="login-username" class="input input-bordered w-full" placeholder="请输入用户名">
        </div>
        <div>
            <label class="block text-xs font-medium text-base-content mb-2">密码</label>
            <input type="password" id="login-password" class="input input-bordered w-full" placeholder="请输入密码">
        </div>
        <button id="login-submit" class="btn btn-primary w-full">登录</button>
    </div>

    <!-- Register Form -->
    <div id="register-form" class="space-y-4 hidden">
        <div>
            <label class="block text-xs font-medium text-base-content mb-2">新用户名（不少于3位）</label>
            <input type="text" id="register-username" class="input input-bordered w-full" placeholder="请输入至少3位的用户名">
        </div>
        <div>
            <label class="block text-xs font-medium text-base-content mb-2">密码（不少于6位）</label>
            <input type="password" id="register-password" class="input input-bordered w-full" placeholder="请输入至少6位的密码">
        </div>
        <div>
            <label class="block text-xs font-medium text-base-content mb-2">确认密码</label>
            <input type="password" id="register-confirm" class="input input-bordered w-full" placeholder="请再次输入密码">
        </div>
        <button id="register-submit" class="btn btn-primary w-full">注册</button>
    </div>

    <!-- Powered by Greener-Dalii Studio -->
    <div class="flex flex-col text-center mt-6">
        <p class="text-xs text-base-content/50">Powered by <a class="font-bold" href="https://www.greenerdalii.top" target="_blank">Greener-Dalii Studio.</a></p>
    </div>
</div>

<script>
    // API base URL
    const API_BASE = '/api';

    // 使用全局API调用函数（登录注册不需要token验证）
    async function apiCall(endpoint: string, options: any = {}) {
        const config = {
            headers: {
                'Content-Type': 'application/json'
            },
            ...options
        };

        try {
            const response = await fetch(`${API_BASE}${endpoint}`, config);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'API request failed');
            }
            
            return data;
        } catch (error: any) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // Auth functions
    async function login(username: string, password: string) {
        try {
            const data = await apiCall('/auth/login', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            
            localStorage.setItem('authToken', data.token);
            (window as any).showToast('登录成功！', 'success');
            document.dispatchEvent(new CustomEvent('loginsuccess', { bubbles: true, composed: true }));
        } catch (error: any) {
            (window as any).showToast(error.message, 'error');
        }
    }

    async function register(username: string, password: string) {
        try {
            const data = await apiCall('/auth/register', {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            
            localStorage.setItem('authToken', data.token);
            (window as any).showToast('注册成功！', 'success');
            document.dispatchEvent(new CustomEvent('loginsuccess'));
        } catch (error: any) {
            (window as any).showToast(error.message, 'error');
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Auth form switching
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');

        loginBtn?.addEventListener('click', () => {
            if (loginBtn) loginBtn.className = 'flex-1 py-2 px-4 rounded-md bg-base-100 shadow-sm font-medium text-primary';
            if (registerBtn) registerBtn.className = 'flex-1 py-2 px-4 rounded-md font-medium text-base-content/60';
            loginForm?.classList.remove('hidden');
            registerForm?.classList.add('hidden');
        });

        registerBtn?.addEventListener('click', () => {
            if (registerBtn) registerBtn.className = 'flex-1 py-2 px-4 rounded-md bg-base-100 shadow-sm font-medium text-primary';
            if (loginBtn) loginBtn.className = 'flex-1 py-2 px-4 rounded-md font-medium text-base-content/60';
            registerForm?.classList.remove('hidden');
            loginForm?.classList.add('hidden');
        });

        // Login form
        const loginSubmit = document.getElementById('login-submit');
        loginSubmit?.addEventListener('click', async () => {
            const usernameInput = document.getElementById('login-username') as HTMLInputElement;
            const passwordInput = document.getElementById('login-password') as HTMLInputElement;
            if (!usernameInput || !passwordInput) return;
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (!username || !password) {
                (window as any).showToast('请填写完整信息', 'error');
                return;
            }
            
            await login(username, password);
        });

        // Register form
        const registerSubmit = document.getElementById('register-submit');
        registerSubmit?.addEventListener('click', async () => {
            const usernameInput = document.getElementById('register-username') as HTMLInputElement;
            const passwordInput = document.getElementById('register-password') as HTMLInputElement;
            const confirmInput = document.getElementById('register-confirm') as HTMLInputElement;
            if (!usernameInput || !passwordInput || !confirmInput) return;
            
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            const confirm = confirmInput.value;
            
            if (!username || !password || !confirm) {
                (window as any).showToast('请填写完整信息', 'error');
                return;
            }
            
            // 用户名验证：至少3位字符，不能为纯数字
            if (username.length < 3) {
                (window as any).showToast('用户名长度至少为3位字符', 'error');
                return;
            }
            
            if (/^\d+$/.test(username)) {
                (window as any).showToast('用户名不能为纯数字', 'error');
                return;
            }
            
            // 密码验证：至少6位，不能为常见弱密码
            if (password.length < 6) {
                (window as any).showToast('密码长度至少为6位', 'error');
                return;
            }
            
            // 使用正则表达式检测弱密码模式
            const weakPasswordPatterns = [
                /^(\d)\1{5,}$/, // 6位或以上相同数字 (如: 111111, 000000)
                /^(.)\1{5,}$/, // 6位或以上相同字符 (如: aaaaaa)
                /^123456\d*$/, // 以123456开头
                /^\d*654321$/, // 以654321结尾
                /^(012|123|234|345|456|567|678|789|890){2,}$/, // 连续数字重复
                /^(abc|bcd|cde|def|efg|fgh|ghi|hij|ijk|jkl|klm|lmn|mno|nop|opq|pqr|qrs|rst|stu|tuv|uvw|vwx|wxy|xyz){2,}$/i, // 连续字母重复
                /^(qwe|wer|ert|rty|tyu|yui|uio|iop|asd|sdf|dfg|fgh|ghj|hjk|jkl|zxc|xcv|cvb|vbn|bnm){2,}$/i, // 键盘序列重复
                /^(password|admin|user|guest|test|demo)\d*$/i, // 常见单词+数字
                /^\d{6,}$/, // 纯数字6位以上
                /^[a-z]{6,}$/i, // 纯字母6位以上
                /^(19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])$/, // 日期格式 (YYYYMMDD)
                /^\d{4}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])$/, // 日期格式 (YYMMDD)
            ];
            
            // 常见弱密码列表作为补充
            const commonWeakPasswords = ['password', 'admin', 'user', 'guest', 'test', 'demo', 'root', 'login', 'welcome', 'qwerty', 'asdfgh', 'zxcvbn'];
            
            const lowerPassword = password.toLowerCase();
            
            // 检查正则表达式模式
            for (const pattern of weakPasswordPatterns) {
                if (pattern.test(lowerPassword)) {
                    (window as any).showToast('密码过于简单，请使用更复杂的密码', 'error');
                    return;
                }
            }
            
            // 检查常见弱密码列表
            if (commonWeakPasswords.includes(lowerPassword)) {
                (window as any).showToast('密码过于简单，请使用更复杂的密码', 'error');
                return;
            }
            
            if (password !== confirm) {
                (window as any).showToast('两次密码输入不一致', 'error');
                return;
            }
            
            await register(username, password);
        });
    });
</script>